<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

		<script src = 'sounds.js'></script>
		<title>Below Hayden</title>
		<link rel = 'stylesheet' href = 'style.css'>
	</head>
	<body>

		<h1>Below Hayden</h1>
		<p>High Score: <span id = 'high-score'></span></p>

		<div>
			<div id = 'hpbar'>
				<strong>Player HP: <span id="playerHP"></span></strong> 
				<div></div>
			</div>
			<strong>Level:</strong> <span id="floor">1</span>
			<strong>Gold:</strong> <span id="gold">1</span>
		</div>

		<div id = 'game-frame'>

			<div id = 'doors'>
				<button onclick="pickDoor(this)" class = 'door'>Door 1</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 2</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 3</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 4</button>
			</div>

			<br/>

			<button class = 'chest closed' onclick = 'useChest()'></button>
			<div class = 'monsters'>
			</div>
			

			<div id="last-log">YOU KICK DOWN THE DOOR. THERE IS A BAT HERE.</div>
			
			<div id = 'inventory'>
				<button class = 'item' data-id = '-1' onmouseleave = "clearItemInfo()" onmouseenter = "showItemInfo(this)" onclick = "useItem(this)" oncontextmenu="return removeItem(this.dataset.id)"></button>
				<button class = 'item' data-id = '-1' onmouseleave = "clearItemInfo()" onmouseenter = "showItemInfo(this)" onclick = "useItem(this)" oncontextmenu="return removeItem(this.dataset.id)"></button>
				<button class = 'item' data-id = '-1' onmouseleave = "clearItemInfo()" onmouseenter = "showItemInfo(this)" onclick = "useItem(this)" oncontextmenu="return removeItem(this.dataset.id)"></button>
				<button class = 'item' data-id = '-1' onmouseleave = "clearItemInfo()" onmouseenter = "showItemInfo(this)" onclick = "useItem(this)" oncontextmenu="return removeItem(this.dataset.id)"></button>
			</div>

			<p id = 'item-info'></p>
		</div>

		<div id="death-text">
			<h2>You died at Level <span id = 'died-at-level'></span>!</h2>
			<p><span id = 'dead-high-score'></span></p>
			<a href="?">Play Again?</a>
		</div>

		<br/>
		<details collapsed>
			<h3>Enemy</h3>
			<div id="enemyInfo"></div>

			<h3>Log</h3>
			<div id="log"></div>
		</details>

		<script>

			if(typeof localStorage.highScore == "undefined") { localStorage.highScore = 10; }
			document.querySelector("#high-score").innerText = Number.parseInt(localStorage.highScore);

			window.id = 0;

			let player = { 
				hp: 20, 
				maxHp: 20, 
				gold: 0, 
				dmg: 1, 
				inventory: [], 
				getDmg: function(){ let d = this.dmg; this.inventory.forEach(item=>{ if(!item.consumable) { d+=item.dmg; } }); return d; },
				getMaxHp: function(){ let d = this.maxHp; this.inventory.forEach(item=>{ if(!item.consumable) { d+=item.hp; } }); return d; }
			};


			let floor = 1
			let enemy = null
			let monsters = [];
			let thisRoomDifficulty = 0;

			const playerHPSpan = document.getElementById('playerHP')
			const floorSpan = document.getElementById('floor')
			const goldSpan = document.getElementById('gold')
			const logDiv = document.getElementById('log')
			const enemyDiv = document.getElementById('enemyInfo')
			const enemyHearts = document.querySelector("#hearts");
			const monsterButton = document.querySelector(".monster");
			const chestButton = document.querySelector(".chest");
			const lastLog = document.querySelector("#last-log");
			const monsterDOM = document.querySelector(".monsters");
			const itemInfo = document.querySelector("#item-info");

			function log(msg) {

				logDiv.innerText += msg + "\n"
				logDiv.scrollTop = logDiv.scrollHeight

				lastLog.innerHTML = msg;
			}

			function updateUI() {

				playerHPSpan.textContent = `${player.hp}/${player.getMaxHp()}`
				floorSpan.textContent = floor
				goldSpan.textContent = player.gold;

				if(floor > localStorage.highScore) {
					localStorage.highScore = floor;
					document.querySelector("#high-score").innerText = floor;
				}

				document.querySelector("#hpbar div").style.width = 100*(player.hp/player.getMaxHp()) + "%";

				monsterDOM.innerHTML = "";

				if(monsters.length > 0) {
					monsters.forEach(monster=>{

						let monsterHearts = "";
						
						for(let v = 0; v < monster.hp; v++) { monsterHearts += "<span class = 'heart'></span>" } 

						let monsterTemplate = `
							<div class = 'monster-container' style = 'width: ${ 90 / monsters.length }%'>
								<div id = 'hearts' style = "visibility:visible;">${monsterHearts}</div>
								<button 
									data-monster-id="${monster.id}" 
									class = 'monster' 
									onclick="attack(${monster.id})"
									style = "background-image: url(monsters/${monster.sprite});display:inline-block;"
								>${monster.name}</button>
							</div>
						`;

						monsterDOM.innerHTML += monsterTemplate;
					});
				}
				
			}


			function Monster(name, sprite, hp=5, dmg=1) {

				this.id = window.id;
				window.id++;
				this.name = name;
				this.sprite = sprite;
				this.maxHp = hp + floor;
				this.hp = this.maxHp + Math.floor(floor / 4);
				this.dmg = dmg;
				this.attack = fn=>{ return this.dmg + (Math.floor(floor / 3)) };
				this.takeDamage = dmg => { this.hp -= dmg; if(this.hp <= 0) { defeatEnemy(this); } }

				return this;
			}


			
			function Item(name, desc, sprite="wee_dung_potion_red.png", sound=sou_potion, hp=0, dmg=0, consumable=true, uses=1, slot=-1, use = -1) {

				this.id = window.id;
				window.id++;
				this.name = name;
				this.desc = desc;
				this.sprite = sprite;
				this.hp = hp;
				this.dmg = dmg;
				this.consumable = consumable;
				this.sound = sound;
				this.uses=uses;
				this.slot = slot;

				if(typeof use == "function") { this.use = use; }
				else {

					this.use = fn=>{
						
						if(this.consumable) {
							

							log(`Used ${this.name}...`);
							console.log(this);

							this.sound.play();

							if(monsters.length > 0 && this.dmg > 0) {

								monsters.forEach(monster=>{
									//monster.hp -= this.dmg;
									attack(monster, `...dealt ${this.dmg}. `);
								});

								//attack(monsters[0], `...dealt ${this.dmg}. `);
							}

							if(this.hp > 0) {
								player.hp += this.hp;
								log(`...healed for ${this.hp}. `);
							}
							if(this.hp < 0) {
								player.hp += this.hp;
								log(`...hurt yourself for ${this.hp}. `);
							}

							if(player.hp >= player.maxHp) { player.hp = player.maxHp; }

							this.uses--;

							if(this.uses <= 0) {
								removeItem(this.id);
							}
						}
						updateUI();
					}
					
				}

				return this;
			}

			function removeItem(id) {
				
				let itemEl = document.querySelector(`[data-id="${id}"]`);
				itemEl.dataset.id = -1;
				itemEl.style.backgroundImage = "";
				player.inventory = player.inventory.filter(i=>{return i.id != id}); 

				return false;
			}

			function useItem(el){
				if(el.dataset.id != -1) {
					let item = player.inventory.filter(item=>{return item.id == el.dataset.id;})[0];
					console.log(item);
					item.use();
				}
			}

			function showItemInfo(el) {

				if(el.dataset.id != -1) {

					let item = player.inventory.filter(item=>{return item.id == el.dataset.id; })[0];

					itemInfo.innerHTML = item.name + "<br/>" + item.desc + " " +  (item.consumable ? ("&mdash; " + item.uses + " uses left.") : "");
				}
			}

			function clearItemInfo() {
				itemInfo.innerHTML = "";
			}

			function generateEnemy(difficultyLevel=0) {
				
				const types = [
					[
						new Monster("Slime", "wee_mons_slime_idle_d_1.png"), 
						new Monster("Bat", "wee_mons_bat_atk_l_1.png"), 
						new Monster("Ghost", "wee_mons_ghost_atk_d_1.png")
					],
					[
						new Monster("Goblin", "wee_mons_gobwar_idle_d_2.png",1,2), 
						new Monster("Skeleton", "wee_mons_skelshield_atk_u_2.png",1,2), 
						new Monster("Zombie", "wee_mons_zombie_atk_d_1.png",1,1)
					],
					[
						new Monster("Red Mage", "wee_mons_mage_atk_d_2.png", 7, 6),
						new Monster("Necromancer", "wee_mons_necro_idle_d_2.png", 2, 8)
					],
					[
						new Monster("Reaper", "wee_mons_reaper_atk_d_1.png", 7, 15)
					],
				];


				const enemy = types[difficultyLevel][Math.floor(Math.random() *  types[difficultyLevel].length)];


				log(`A wild ${enemy.name} appears!`)

				return enemy;
			}

			function defeatEnemy(enemy) {

				log(`You defeated the ${enemy.name}!`);



				monsters = monsters.filter(monster=>{ return monster.hp > 0; });
				

				floor += 1 + thisRoomDifficulty;
				player.maxHp++;
				player.dmg += .3;

				if(monsters.length == 0) {

					chestButton.classList.add("closed");
					chestButton.style.visibility = "visible";
					

					setTimeout(fn=>{
						chestButton.style.opacity = 1;
					},1);
					
					enableDoors();
				}

				updateUI();
			}

			function lockMonsters() {
				document.querySelectorAll(".monsters button").forEach(monster=>{monster.disabled = true;})
			}

			function unlockMonsters() {
				document.querySelectorAll(".monsters button").forEach(monster=>{monster.disabled = false;})
			}


			function attack(enemy, doAttack=true, extraLog="") {

				if(typeof enemy == "number") {
					enemy = monsters.filter(monster=>{ return monster.id == enemy; })[0];
				}

				let logText = extraLog;

				if(!enemy) {
					logText += ("There is nothing to attack.")
					return
				}

				if(doAttack) {

					const playerDmg = Math.floor(player.getDmg() + (Math.random() * 3));
					enemy.hp -= playerDmg;
					logText += (`You hit the ${enemy.name} for ${playerDmg} damage.`);
					sou_punch[Math.floor(Math.random() * sou_punch.length)].play();

					setTimeout(fn=>{
						let d = document.querySelector(`[data-monster-id="${enemy.id}"]`);
						if(d != null) {
							document.querySelector(`[data-monster-id="${enemy.id}"]`).style.animation = "shake .5s ease 0s 1 normal forwards";
						}
					},1,enemy);
				}

				log(logText);


				if(enemy.hp <= 0) {
					sou_kill_foe.play();
					defeatEnemy(enemy);
					updateUI();
				} 
				else {

					updateUI();

					lockMonsters();

					setTimeout(fn=>{

						let logText = "";

						sou_punch[Math.floor(Math.random() * sou_punch.length)].play();

						const enemyDmg = enemy.attack()
						player.hp -= enemyDmg;

						logText += (`The ${enemy.name} hits you for ${enemyDmg} damage.`)

						log(logText);

						updateUI();
						lockMonsters();
						

						if (player.hp <= 0) {
							logText += ("You died! Game over.")

							
							document.querySelector("#death-text").classList.add("dead");
							document.querySelector("#game-frame").classList.add("dead");

							document.querySelector("#died-at-level").innerHTML = floor;
							document.querySelector("#dead-high-score").innerHTML = floor >= localStorage.highScore ? "A NEW HIGH SCORE!" : ("High Score:"+localStorage.highScore);
							
						
						}

						setTimeout(fn=>{

							log("Your turn.");
							
							unlockMonsters();
						}, 1000);

					}, 1000);
				}

				
			}

			currentChestContents = null

			function useChest() {

				if(chestButton.classList.contains("closed")) {
					log("You open the chest...");
					sou_door.play();
					return chestButton.classList.remove("closed");
				}

				if(!chestButton.classList.contains("empty") && currentChestContents == null) {
				
					let dice = Math.floor(Math.random() * 20) + 1;

					//Give gold
					if(dice < 7) {
						sou_foundSomethingSm.play();
						let gold = floor * Math.round(Math.random() * 20) + 5;

						log(`FOUND ${gold} GOLD`);
						player.gold += gold;
						chestButton.classList.add("empty");
					}

					//Give item
					else if(dice < 18) {
						sou_foundSomethingMd.play();

						let items = [
							new Item("Potion", "Heal yourself", "dungeon/wee_dung_potion_red.png", sou_potion, 10,0,true,1),
							new Item("Scroll", "Cast magic spell", "dungeon/wee_dung_scroll.png", sou_fire, 0, 1+Math.floor(floor/3),true,3),
						];

						let item = items[Math.floor(Math.random() * items.length)];

						item.name += " of +" + (item.dmg||item.hp);

						if(player.inventory.length < 4) {
							giveItem(item);
							log("FOUND " + item.name);
							chestButton.classList.add("empty");
							currentChestContents = null;
						}
						else {
							currentChestContents = item;
							log("FOUND " + item.name + ". Inventory full!");
						}

					}
					
					//Give gear
					else {
						sou_foundSomethingLg.play();

						let items = [
							new Item("Sword", "Deal extra damage", "dungeon/wee_dung_sword.png", sou_potion, 0, floor + thisRoomDifficulty,false,1, "weapon"),
							new Item("Helm", "Increase max HP", "dungeon/wee_dung_helm.png", sou_potion, 4 + thisRoomDifficulty, 0,false,1, "helm"),
						];

						let item = items[Math.floor(Math.random() * items.length)];

						item.name += " of +" + (item.dmg || item.hp);
						
						let slotIsEmpty = (item.slot == -1 || player.inventory.filter(i=>{ return i.slot == item.slot;}).length == 0);
						
						if(player.inventory.length < 4 && slotIsEmpty) {
							
							giveItem(item);
							log("FOUND " + item.name);
							chestButton.classList.add("empty");
							currentChestContents = null;

						}
						else if(!slotIsEmpty) {
							
							currentChestContents = item;
							log("FOUND " + item.name + ". Can only have one " + item.slot + " at a time!");
						}
						else {
							currentChestContents = item;
							log("FOUND " + item.name + ". Inventory full!");
						}
					}


					updateUI();
				}

				else if(currentChestContents != null) {
					if(player.inventory.length < 4) {
						giveItem(currentChestContents);
						chestButton.classList.add("empty");
						log("FOUND " + item.name);
						currentChestContents = null;
					}
					else {
						log("FOUND " + currentChestContents.name + ". Inventory full!");
					}
				}
			}

			function giveItem(item) {

				currentChestContents = null;
				
				player.inventory.push(item);
				let found = false;

				document.querySelectorAll(".item").forEach(el=>{
					if(el.dataset.id == '-1' && !found) {
						el.style.backgroundImage = `url("${item.sprite}")`;
						el.dataset.id = item.id;
						found = true;
					}
				});
			}

			function pickDoor(el) {
				

				disableDoors();
				el.classList.add("open");
				sou_door.play();

				//if(el.classList.contains("stairs")) { floor += 4; }

				setTimeout(fn=>{
					el.classList.add("chosen");
					sou_stairs.play();
					document.body.style.opacity = 0;

					setTimeout(()=>{
						el.classList.remove("chosen");
						el.classList.remove("open");


						setTimeout(()=>{
							document.body.style.opacity=1;
							document.querySelector("#doors").innerHTML = "";
							enterPath(el.dataset.level);
						},200,el);

					},500,el);
				}, 500);
			}

			function enterPath(difficultyLevel) {

				console.log(difficultyLevel);

				difficultyLevel= Number.parseInt(difficultyLevel)||0;
				thisRoomDifficulty = difficultyLevel;
				randomizeDoors();
				disableDoors();
				
				chestButton.style.visibility = "hidden";
				chestButton.style.opacity = 0;
				chestButton.classList.remove("empty");
				currentChestContents = null;
			
				if (player.hp <= 0) return

				
				player.hp = Math.min(player.hp + 5, player.getMaxHp())

				for(let v = 0; v < 1 + Math.floor(Math.random() * 5); v++) {
					enemy = generateEnemy(difficultyLevel);
					monsters.push(enemy);
				}

				log(`You enter the room. There's a ${monsters.map(m=>{ return m.name }).join(", and a ") } here!`)
				updateUI()
			}

			function randomizeDoors() {


				for(let v = 0; v < 1 + Math.round(Math.random() * 3); v++) {
					

					let dice = Math.random() * 20;
					let dlvl = dice < 16 ? 0 : Math.floor(20-dice);

					document.querySelector("#doors").innerHTML += `
						<button onclick="pickDoor(this)" style = 'background-image:url(dungeon/door${dlvl}.png);' class = 'door' data-level="${
							dlvl
						}">Door ${v}</button>
					`;
				}


				document.querySelectorAll(".door").forEach(door=>{ 

					let dice = Math.floor(Math.random() * 20) + 1;

					if(dice == 6) { door.style.backgroundImage = `url("dungeon/wee_dung_stair_blue_down.png")`; door.classList.add("stairs"); }
				});
			}
			function disableDoors() {
				document.querySelectorAll(".door").forEach(door=>{ 
					door.disabled = true; 
				});
			}
			function enableDoors() {
				document.querySelector("#doors").style.visibility = "visible";
				document.querySelectorAll(".door").forEach(door=>{ 
					door.disabled = false; 
				});
			}

			function restart() {
				player.hp = 20
				floor = 1
				logDiv.innerText = ''
				
				log("You awaken in a dungeon. Choose a door to explore.")

				updateUI()
			}


			// Start game
			restart()
		</script>
	</body>
</html>
