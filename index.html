<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />

		<title>Below Hayden</title>

		<script src = 'sounds.js?1111'></script>
		<link rel = 'stylesheet' href = 'style.css?1111' />
		<link href="https://cdn.jsdelivr.net/npm/@fontsource/unifont@5.2.5/index.min.css" rel="stylesheet" />

	</head>
	<body>

		<h1 class = 'game-title'>Below Hayden</h1>

		<div id = 'main-ui'>
			<marquee>High Score: <span id = 'high-score'></span></marquee>
			<div>
				<div id = 'hpbar' class = 'bar'>
					<strong>HP: <span id="playerHP"></span></strong> 
					<div></div>
				</div>
				<div id = 'xpbar' class = 'bar'>
					<strong>XP: <span id="playerXP"></span></strong> 
					<div></div>
				</div>
				<strong id = 'level-label'>Level:</strong> <span id="floor">1</span>
				<strong>Gold:</strong> <span id="gold">1</span>
			</div>
		</div>

		<div id = 'game-frame'>

			<div id = 'doors'>
				<button onclick="pickDoor(this)" class = 'door'>Door 1</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 2</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 3</button>
				<button onclick="pickDoor(this)" class = 'door'>Door 4</button>
			</div>

			<br/>

			<div class = 'monsters'>
			</div>

			<button class = 'chest closed' onclick = 'useChest()'></button>
			

			<div id="last-log">YOU KICK DOWN THE DOOR. THERE IS A BAT HERE.</div>
			
			<div id = 'inventory'>
				<button class = 'item' data-id = '-1' onclick = "showItemInfo(this)"></button>
				<button class = 'item' data-id = '-1' onclick = "showItemInfo(this)"></button>
				<button class = 'item' data-id = '-1' onclick = "showItemInfo(this)"></button>
				<button class = 'item' data-id = '-1' onclick = "showItemInfo(this)"></button>
			</div>

			<p id = 'item-info'></p>
		</div>

		<div id="death-text">
			<h2>You died at Level <span id = 'died-at-level'></span>!</h2>
			<p><span id = 'dead-high-score'></span></p>
			<a href="?">Play Again?</a>
		</div>

		<div id="level-up"><h2>LEVEL UP!</h2></div>

		<br/>
		<details style = 'display:none;'>
			<h3>Enemy</h3>
			<div id="enemyInfo"></div>

			<h3>Log</h3>
			<div id="log"></div>
		</details>

		<script src = 'data/monsterList.js'></script>
		<script src = 'data/itemList.js'></script>

		<script>

			setTimeout(fn=>{
				document.body.style.opacity = 1;
			}, 500);

			if(typeof localStorage.highScore == "undefined") { localStorage.highScore = 10; }
			document.querySelector("#high-score").innerText = Number.parseInt(localStorage.highScore);

			window.id = 0;

			let basicAttack = new Item("Basic Attack",-1,-1, sou_punch[0], 0, 1, 0);

			let player = { 
				hp: 20, 
				maxHp: 20, 
				gold: 0, 
				dgold:0,
				dmg: 1,
				level: 1,
				inventory: [], 
				xp:0,
				dhp: 20,
				dxp: 0,

				getXPToNextLevel: fn=>{ return 100 * (player.level ** 3); },
				handleLeveling: function() {


					let xpToNextLevel = player.getXPToNextLevel();

					//XPToLevel(n) = XPBase * (n ^ LevelCurve)

					//document.querySelector("#xpbar div").style.width = ((player.xp / xpToNextLevel) * 100) + "%"

					if(player.xp > xpToNextLevel) {

						document.querySelector("#level-up").classList.toggle("level-up-slide");

						sou_level_up.play();

						player.level++;
						player.maxHp += 10;
						player.dmg++;
						player.hp = player.getMaxHp();
						player.xp = 0;

					}
				},
				getDmg: function(){ let d = this.dmg + (player.level / 4); this.inventory.forEach(item=>{ if(!item.consumable) { d+=item.dmg; } }); return d; },
				getMaxHp: function(){ let d = this.maxHp; this.inventory.forEach(item=>{ if(!item.consumable) { d+=item.hp; } }); return d; },
				attack: function(targets, item=false) {
					
					if(!Array.isArray(targets)) { targets = [targets]; }

					//Run through each of our targets and deal damage/play sound/animation
					targets.forEach((monster,ind)=>{

						if(typeof monster == "number") { monster = monsters.filter(m=>{return m.id == monster; })[0]; }

						setTimeout(fn=>{

							let crit = false;
							let playerDmg = item ? item.getDmg() : Math.floor(player.getDmg() + (Math.random() * 6));
							let logText = "";

							if(Math.round(Math.random() * 20) > 18) {
								logText += "<span class = 'critText'>CRITICAL HIT!</span>&nbsp;";
								playerDmg *= 2;
								crit = true;

								sou_crit.play();
							}

							if(item) {
								if(typeof item.sound == "string") { window[item.sound].play() }
								else { item.sound.play(); }
							}
							else {
								sou_punch[Math.floor(Math.random() * sou_punch.length)].play();
							}

							monster.takeDamage(playerDmg, false);
							
							setTimeout(fn=>{
								let d = document.querySelector(`[data-monster-id="${monster.id}"]`);
								if(d != null) {
									document.querySelector(`[data-monster-id="${monster.id}"]`).style.animation = "shake .5s ease 0s 1 normal forwards";
								}
							},1, monster);

							log(`${logText} Hit ${monster.name} for ${playerDmg}.`);

							if(crit) { bindCritAnimation(); }

							updateUI();
							lockMonsters();

						}, 500 * ind);
					});


					//After we've hit all our targets, check if anyone/everyone is dead and remove them.
					setTimeout(fn=>{

						updateUI();

						let delay = 1;

						monsters.forEach((monster,ind)=>{

							if(monster.hp <= 0) {


								setTimeout(fnz=>{

										
									defeatEnemy(monster);

								},delay);
								delay += 350;
							}

						});

						setTimeout(fn=>{
							monsterTurn();
						}, delay);

						//unlockMonsters();

					}, (monsters.length * 500) + 250);

				}
			};


			giveItem(new Item("Healing Potion", "Heal yourself", "dungeon/wee_dung_potion_red.png", sou_potion, 10,0,true,1));
			giveItem(new Item("Pyro Scroll of +3", "Cast fire spell on all enemies", "dungeon/wee_dung_scroll.png", sou_fire, 0, 3,true,3));


			let floor = 1
			let enemy = null
			let monsters = [];
			let thisRoomDifficulty = 0;

			const playerHPSpan = document.getElementById('playerHP')
			const playerXPSpan = document.getElementById('playerXP')
			const floorSpan = document.getElementById('floor')
			const goldSpan = document.getElementById('gold')
			const logDiv = document.getElementById('log')
			const enemyDiv = document.getElementById('enemyInfo')
			const enemyHearts = document.querySelector("#hearts");
			const monsterButton = document.querySelector(".monster");
			const chestButton = document.querySelector(".chest");
			const lastLog = document.querySelector("#last-log");
			const monsterDOM = document.querySelector(".monsters");
			const itemInfo = document.querySelector("#item-info");

			function log(msg) {

				logDiv.innerText += msg + "\n"
				logDiv.scrollTop = logDiv.scrollHeight

				lastLog.innerHTML = msg;
			}

			let ubto = -1;

			function updateBars() {


				playerHPSpan.textContent = `${Math.round(player.dhp)}/${Math.round(player.getMaxHp())}`
				playerXPSpan.textContent = `${Math.round(player.dxp)}/${Math.round(player.getXPToNextLevel())}`

				document.querySelector("#hpbar div").style.width = 100*(player.dhp/player.getMaxHp()) + "%";
				document.querySelector("#xpbar div").style.width = 100*(player.dxp/player.getXPToNextLevel()) + "%";

				let xp = player.xp;
				let hp = player.hp;
				let gold = player.gold

				if(player.dgold < gold) { player.dgold++; }
				if(player.dgold > gold) { player.dgold--; }

				if(player.dxp < xp) { player.dxp += 1; }
				if(player.dxp > xp) { player.dxp = xp; }

				if(player.dhp < hp) { player.dhp+=.2; }
				if(player.dhp > hp) { player.dhp-=.2; }

				
				goldSpan.innerText = player.dgold;

				if(player.dhp != hp || player.dxp != xp || player.dgold != player.gold) { clearTimeout(ubto); ubto = setTimeout(fn=>{ updateBars(); }, 5); }

			}
			

			function updateUI() {

				itemInfo.classList.remove("open");
				
				updateBars();

				floorSpan.textContent = player.level
				goldSpan.textContent = player.gold;

				if(player.level > localStorage.highScore) {
					localStorage.highScore = player.level;
					document.querySelector("#high-score").innerText = floor;
				}

				monsterDOM.innerHTML = "";

				if(monsters.length > 0) {
					monsters.forEach(monster=>{

						let monsterHearts = monster.formatHearts();
						

						let monsterTemplate = `
							<div data-monster-container = "${monster.id}" class = 'monster-container' style = 'width: ${ 80 / monsters.length }%'>
								<div class = 'hearts' style = "visibility:visible;">${monsterHearts}</div>
								<button 
									data-monster-id="${monster.id}" 
									class = 'monster' 
									onclick="player.attack(${monster.id})"
									style = "background-image: url(monsters/${monster.sprite});display:inline-block;"
								>${monster.name}</button>
							</div>
						`;

						monsterDOM.innerHTML += monsterTemplate;
					});
				}

				updateInventoryUI();
				
			}

			function updateInventoryUI() {
				document.querySelectorAll("button.item").forEach(item=>{

					if(item.dataset.id != -1) {
						let ii = player.inventory.filter(pi=>{return pi.id == item.dataset.id})[0];
						if(typeof ii != "undefined") {

							if(ii.consumable) { item.innerText = ii.uses; }
						}
					}
					else {
						item.innerText = "";
					}
				});
			}


			function Monster(name, sprite, hp=5, dmg=1, strongTo=[], weakTo=[]) {

				this.id = window.id;
				window.id++;
				this.name = name;
				this.sprite = sprite;
				this.maxHp = (hp +  Math.floor(floor / 3)) * (thisRoomDifficulty+1);
				this.hp = this.maxHp;
				this.dmg = dmg;


				this.attack = fn=>{ 

					
					sou_punch[Math.floor(Math.random() * sou_punch.length)].play();

					let dmg = this.dmg + (Math.floor(floor / 3)) + Math.floor(Math.random() * 6);
					player.hp -= dmg;


					log(`The ${this.name} hits you for ${dmg} damage.`)

					updateUI();
					lockMonsters();

					document.querySelector(`[data-monster-id="${ this.id }"]`).style.animation = "enemyAttack .5s ease 0s 1 normal forwards";
					setTimeout(fn=>{document.querySelector(`[data-monster-id="${ this.id }"]`).style.animation = "combatIdle 2s ease 0s infinite normal forwards";}, 512);

					checkIsDefeated();
				};

				this.takeDamage = (dmg, autocull) => { 
					this.hp -= dmg; 
					if(this.hp <= 0 && autocull) { defeatEnemy(this); } 
				}

				this.formatHearts = function() {

					let monsterHearts = "";

					if(this.hp < 10) {
						for(let v = 0; v < this.hp; v++) { monsterHearts += "<span class = 'heart'></span>" } 
					}
					else { monsterHearts = "<span class = 'heart'>&nbsp;x"+this.hp+"</span>"; }

					return monsterHearts;
				}

				return this;
			}

			function monsterTurn() {

				updateUI();
				lockMonsters();

				monsters.forEach((monster,ind)=>{
					setTimeout(fn=>{

						monster.attack();

					}, 500 * ind);

				});

				setTimeout(fn=>{

					if(!checkIsDefeated() && monsters.length > 0) {

						
						updateUI();

						log("YOUR TURN.");

						unlockMonsters();
					}
				}, (500 * monsters.length));
			}

			function dice(numberOfDice, numberOfSides) {
				let d = 0;
				for(let v = 0; v < this.numberOfDice; v++) {
					d += 1 + Math.round(Math.random() * (this.numberOfSides - 1));
				}
				return d;
			}

			
			function Item(name, desc, sprite="wee_dung_potion_red.png", sound=sou_potion, hp=0, dmg=0, numberOfDice, numberOfSides, consumable=true, uses=1, slot=-1, use = -1) {

				this.id = window.id;
				window.id++;
				this.name = name;
				this.desc = desc;
				this.sprite = sprite;
				this.hp = hp;
				this.dmg = dmg;
				this.consumable = consumable;
				this.sound = sound;
				this.uses=uses;
				this.slot = slot;
				this.value = 10;

				this.getName = function() {

					return this.name + " of +" + (this.dmg||this.hp);
				}

				this.numberOfDice = numberOfDice;
				this.numberOfSides = numberOfSides;

				this.getDmg = function() {
					return this.dmg + dice(this.numberOfDice, this.numberOfSides);
				}

				if(typeof use == "function") { this.use = use; }
				else {

					this.use = (override=false)=>{
						
						if(this.consumable || override) {
							

							log(`Used ${this.name}...`);
							console.log(this);

							if(monsters.length > 0 && this.dmg > 0) {

								lockMonsters();

								player.attack(monsters, this);
								
							}
							else {

								if(typeof this.sound == "string") {
									window[this.sound].play();
								}
								else {
									this.sound.play();
								}

								if(this.hp > 0) {


									player.hp += this.hp + dice(this.numberOfDice, this.numberOfSides);
									log(`...healed for ${this.hp}. `);
								}

								if(player.hp >= player.maxHp) { player.hp = player.maxHp; }

								updateUI();
							}

							this.uses--;

							if(this.uses <= 0) {
								removeItem(this.id);
							}
						}

					}
					
				}

				return this;
			}

			function removeItem(id) {

				if(typeof id != "number") {id = id.dataset.id; }
				
				let itemEl = document.querySelector(`[data-id="${id}"]`);
				itemEl.dataset.id = -1;
				itemEl.style.backgroundImage = "";
				player.inventory = player.inventory.filter(i=>{return i.id != id}); 

				return false;
			}

			function useItem(el){

				let id = typeof el == "number" ? el : el.dataset.id;

				if(id != -1) {
					let item = player.inventory.filter(item=>{return item.id == id;})[0];
					console.log(item);
					item.use();
				}
			}

			function showItemInfo(el) {

				if(el == -1) {
					return  itemInfo.classList.remove("open");
				}

				if(el.dataset.id != -1) {

					sou_menu_open.play();

					if(itemInfo.classList.contains("open") && itemInfo.dataset.item == el.dataset.id) { itemInfo.classList.remove("open"); }
					else { itemInfo.classList.add("open"); }


					itemInfo.dataset.item = el.dataset.id;
					
					let isShop = el.classList.contains("shop");

					let item = -1;
					if(isShop) {
						item = itemShopItems.filter(i=>{ console.log(i.id); return i.id == el.dataset.id; })[0];
					}
					else {
						item = player.inventory.filter(i=>{ console.log(i.id); return i.id == el.dataset.id; })[0];
					}
					itemInfo.innerHTML = `
						${ item.getName() }<br/>
						${(item.consumable ? (item.uses + " uses left.") : "")}<br/>
						<div>${item.desc}</div>

						${
							!isShop ?
								`<button onclick = "useItem(this);updateUI();" data-id="${el.dataset.id}">USE</button> 
								<button onclick = "removeItem(this);sou_item_drop.play();updateUI();" data-id="${el.dataset.id}">DROP</button>`
							:
								`
								<button onclick = "buyItem(this);" data-id="${item.id}">BUY FOR ${item.value}</button> 
								`
						}
					`;
				}
				else {
					itemInfo.classList.remove("open"); 
				}
			}

			function clearItemInfo() {
				itemInfo.innerHTML = "";
			}
			
			

			function generateEnemy(difficultyLevel=0) {
				
				


				const enemy = new Monster(...monsterList[floor-1][Math.floor(Math.random() *  monsterList[floor-1].length)]);
				enemy.level = thisRoomDifficulty;

				log(`A wild ${enemy.name} appears!`)

				return enemy;
			}

			function defeatEnemy(enemy) {

					
				sou_kill_foe.play();
				log(`You defeated the ${enemy.name}!`);



				monsters = monsters.filter(monster=>{ return monster.id != enemy.id; });
				

				//floor += 1 + thisRoomDifficulty;

				//XP = BaseXP * (EnemyLevel ^ EnemyPowerCurve)
				
				player.xp += 10 * (enemy.maxHp ** 1.3) * (thisRoomDifficulty+1);
				player.handleLeveling();
				

				if(monsters.length == 0) {

					chestButton.classList.add("closed");
					chestButton.style.visibility = "visible";
					

					setTimeout(fn=>{
						chestButton.style.opacity = 1;
					},1);
					
					enableDoors();

					sou_chest_fadeIn.play();
				}

				updateUI();
			}

			function lockMonsters() {
				document.querySelectorAll(".monsters button").forEach(monster=>{monster.disabled = true;})
			}

			function unlockMonsters() {
				document.querySelectorAll(".monsters button").forEach(monster=>{monster.disabled = false;})
			}


			function checkIsDefeated() { 

				if (player.hp <= 0) {
					log("You died! Game over.")

					sou_gameover.play();
					
					document.querySelector("#death-text").classList.add("dead");
					document.querySelector("#game-frame").classList.add("dead");

					document.querySelector("#died-at-level").innerHTML = player.level;
					document.querySelector("#dead-high-score").innerHTML = player.level >= localStorage.highScore ? "A NEW HIGH SCORE!" : ("High Score:"+localStorage.highScore);
					
					return true;
				}
				return false;
			}

			currentChestContents = null

			function useChest() {

				if(chestButton.classList.contains("closed")) {
					log("You open the chest...");
					sou_door.play();
					return chestButton.classList.remove("closed");
				}

				if(!chestButton.classList.contains("empty") && currentChestContents == null) {
				
					let dice = Math.floor(Math.random() * 20);// + 1 + thisRoomDifficulty*2;

					//Give gold
					if(dice < 7) {
						sou_foundSomethingSm.play();
						let gold = thisRoomDifficulty * Math.round(Math.random() * 20) + 5;

						log(`FOUND ${gold} GOLD`);
						player.gold += gold;
						chestButton.classList.add("empty");
					}

					//Give item
					else if(dice >= 7 && dice < 12) {
						sou_foundSomethingMd.play();

						let item = new Item(...items[Math.floor(Math.random() * items.length)]);

						let isDuplicate = player.inventory.filter(i=>{ return i.getName() == item.getName(); }).length > 0;

						if(player.inventory.length < 4 || isDuplicate) {
							giveItem(item);
							log("FOUND " + item.getName());
							chestButton.classList.add("empty");
							currentChestContents = null;
						}
						else {
							currentChestContents = item;
							log("FOUND " + item.getName() + ". Inventory full!");
						}

					}
					
					//Give gear
					else {
						sou_foundSomethingLg.play();

						let item = new Item(...gear[Math.floor(Math.random() * gear.length)]);

						if(item.dmg != 0) { item.dmg += ((floor / 5) + Math.floor(Math.random() * 4) + thisRoomDifficulty) * (Math.abs(item.dmg) / item.dmg); }
						if(item.hp != 0) { item.hp += ((floor / 5) + Math.floor(Math.random() * 4) + thisRoomDifficulty) * (Math.abs(item.hp) / item.hp); }
						
						let slotIsEmpty = (item.slot == -1 || player.inventory.filter(i=>{ return i.slot == item.slot;}).length == 0);
						
						if(player.inventory.length < 4 && slotIsEmpty) {
							
							giveItem(item);
							log("FOUND " + item.getName());
							chestButton.classList.add("empty");
							currentChestContents = null;

						}
						else if(!slotIsEmpty) {
							
							currentChestContents = item;
							log("FOUND " + item.getName() + ". Can only have one " + item.slot + " at a time!");
						}
						else {
							currentChestContents = item;
							log("FOUND " + item.getName() + ". Inventory full!");
						}
					}


					updateUI();
				}

				else if(currentChestContents != null) {
					
					let slotIsEmpty = (currentChestContents.slot == -1 || player.inventory.filter(i=>{ return i.slot == currentChestContents.slot;}).length == 0);
					
					if(!slotIsEmpty) {
							
						currentChestContents = item;
						log("FOUND " + item.getName() + ". Can only have one " + item.slot + " at a time!");
					}
					else if(player.inventory.length < 4) {
						log("FOUND " + currentChestContents.getName());
						giveItem(currentChestContents);
						chestButton.classList.add("empty");
						currentChestContents = null;
					}
					else {
						log("FOUND " + currentChestContents.getName() + ". Inventory full!");
					}
				}
			}

			function giveItem(item) {

				currentChestContents = null;

				for(let i = 0; i < player.inventory.length; i++) {

					let it = player.inventory[i];

					if(it.getName() == item.getName() && it.consumable && item.consumable) {

						it.uses += item.uses;
						return;
					}
				}
				
				player.inventory.push(item);
				let found = false;

				document.querySelectorAll(".item").forEach(el=>{
					if(el.dataset.id == '-1' && !found) {
						el.style.backgroundImage = `url("${item.sprite}")`;
						el.dataset.id = item.id;
						found = true;
					}
				});
			}

			function pickDoor(el) {
				
				sou_shop_music.sound.pause()
				
				disableDoors();
				el.classList.add("open");
				sou_door.play();

				if(el.classList.contains("stairs")) { floor += 1; }

				setTimeout(fn=>{
					el.classList.add("chosen");
					sou_stairs.play();
					document.body.style.opacity = 0;

					setTimeout(()=>{
						el.classList.remove("chosen");
						el.classList.remove("open");


						setTimeout(()=>{
							document.body.style.opacity=1;
							document.querySelector("#doors").innerHTML = "";
							enterPath(el.dataset.level);
						},200,el);

					},500,el);

				}, 500);
			}

			function enterPath(difficultyLevel) {

				console.log(difficultyLevel);

				let isShop = difficultyLevel == "_shop";

				difficultyLevel = Math.min(monsterList.length - 1, (Number.parseInt(difficultyLevel)||0) );
				thisRoomDifficulty = difficultyLevel;
				randomizeDoors();
				
				
				chestButton.style.visibility = "hidden";
				chestButton.style.opacity = 0;
				chestButton.classList.remove("empty");
				currentChestContents = null;
			
				if (player.hp <= 0) return

				
				player.hp = Math.min(player.hp + 5, player.getMaxHp())

				if(!isShop) {
					disableDoors();
					
					for(let v = 0; v < 1 + Math.floor(Math.random() * (2 + floor + difficultyLevel)); v++) {
						
						enemy = generateEnemy(difficultyLevel);
						monsters.push(enemy);
					}

					
					log(`You enter the room. There's a ${monsters.map(m=>{ return m.name }).join(", and a ") } here!`)
					updateUI()
				}
				else {
					showShop();
				}


			}

			function randomizeDoors() {


				for(let v = 0; v < 1 + Math.round(Math.random() * 3); v++) {
					

					let dice = Math.random() * 20;

					let dlvl = dice < 16 + (floor / 5) ? 0 : Math.floor(20-dice);

					if(Math.random() * 100 > 90) { dlvl = "_shop"; }

					document.querySelector("#doors").innerHTML += `
						<button onclick="pickDoor(this)" style = 'background-image:url(dungeon/door${dlvl}.png);' class = 'door' data-level="${
							dlvl
						}">Door ${v}</button>
					`;
				}


				document.querySelectorAll(".door").forEach(door=>{ 

					let dice = Math.floor(Math.random() * 20) + 1;

					if(dice == 6) { door.style.backgroundImage = `url("dungeon/wee_dung_stair_blue_down.png")`; door.classList.add("stairs"); }
				});
			}
			function disableDoors() {
				document.querySelectorAll(".door").forEach(door=>{ 
					door.disabled = true; 
				});
			}
			function enableDoors() {
				document.querySelector("#doors").style.visibility = "visible";
				document.querySelectorAll(".door").forEach(door=>{ 
					door.disabled = false; 
				});
			}

			itemShopItems = [];

			function showShop() {

				sou_shop_music.play();

				log('"BUY SOMETHING, WILL YOU?"');

				itemShopItems = [

					new Item(...window.items[0]),
					new Item(...window.gear[Math.round(Math.random() * window.gear.length-1)]),
					new Item(...window.items[0]),
				];


				monsterDOM.innerHTML = `
					<img src="monsters/shopkeeper.png" width="80" height="80">
					<button class = 'item shop' data-shop=1 onclick = 'showItemInfo(this);'></button>
					<button class = 'item shop' data-shop=1 onclick = 'showItemInfo(this);'></button>
					<button class = 'item shop' data-shop=1 onclick = 'showItemInfo(this);'></button>
				`;

				itemShopItems.forEach((item,ind)=>{

					let el = monsterDOM.querySelectorAll(".item.shop")[ind];
					
					el.style.backgroundImage = `url("${item.sprite}")`;
					el.dataset.id = item.id;
					
				});
			}

			function buyItem(el) {

				let item = itemShopItems.filter(i=>{return i.id == el.dataset.id;})[0];

				console.log(item);

				let slotTaken = item.slot != -1 && player.inventory.filter(i=>{return i.slot == item.slot;}).length > 0;

				if(player.gold >= item.value && player.inventory.length < 4 && !slotTaken) {

					player.gold -= item.value;
					giveItem(item);
					itemShopItems = itemShopItems.filter(i=>{return i.id != item.id;})

					let idom = document.querySelector(`.shop.item[data-id="${item.id}"]`);
					idom.style.backgroundImage = "";
					idom.dataset.id = -1;

					showItemInfo(-1);

					updateInventoryUI();
					updateBars();
					
				}

				else if(player.gold < item.value) { log(`"You can't afford that!"`); }
				else if(player.inventory.length >= 4) { log(`"Inventory is full!"`); }
				else if(slotTaken) { log(`"You can only have one ${item.slot} at a time!"`); }
			}

			function restart() {
				player.hp = 20
				floor = 1
				logDiv.innerText = '';
				
				log("You awaken in a dungeon.<br/>Choose a door to explore.")

				updateUI()
			}


			// Start game
			restart();


			//https://codepen.io/zachkrall/pen/MWWGMPx
			function bindCritAnimation(){

				let h1 = document.querySelector(".critText");

				h1.innerHTML = h1.innerHTML
					.split("")
					.map(letter => {
					console.log(letter);
					return `<span>` + letter + `</span>`;
					})
					.join("");

				Array.from(h1.children).forEach((span, index) => {
					setTimeout(() => {
						span.classList.add("wavy");
					}, index * 60);
				});

			}
		</script>
	</body>
</html>
